generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  EDITOR
  ADMIN

  @@map("user_role")
}

enum OrderStatus {
  UNPAID
  PAID
  PROCESSING
  COMPLETED
  CANCELLED

  @@map("order_status")
}

enum PaymentGateway {
  STRIPE
  VNPAY
  PAYOS

  @@map("payment_gateway")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@map("payment_status")
}

enum WalletLedgerType {
  TOPUP
  ORDER_PAYMENT
  REFUND
  ADJUSTMENT

  @@map("wallet_ledger_type")
}

model User {
  id              String         @id @default(uuid()) @db.Uuid
  email           String         @unique @db.VarChar(255)
  name            String?        @db.VarChar(255)
  passwordHash    String?        @map("password_hash") @db.VarChar(255)
  role            UserRole       @default(CLIENT)
  emailVerifiedAt DateTime?      @map("email_verified_at") @db.Timestamptz
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  orders          Order[]
  payments        Payment[]
  subscriptions   Subscription[]
  wallet          Wallet?
  walletLedgers   WalletLedger[]

  @@map("users")
}

model Order {
  id            String         @id @default(uuid()) @db.Uuid
  orderNumber   String         @unique @map("order_number") @db.VarChar(50)
  orderName     String         @map("order_name") @db.VarChar(500)
  totalCount    Int            @map("total_count")
  totalAmount   Decimal        @map("total_amount") @db.Decimal(10, 2)
  status        OrderStatus    @default(UNPAID)
  clientId      String?        @map("client_id") @db.VarChar(100)
  clientName    String?        @map("client_name") @db.VarChar(255)
  userId        String         @map("user_id") @db.Uuid
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz
  paidAt        DateTime?      @map("paid_at") @db.Timestamptz
  completedAt   DateTime?      @map("completed_at") @db.Timestamptz
  items         OrderItem[]
  payments      Payment[]
  files         File[]
  walletLedgers WalletLedger[]

  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid()) @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  type       String   @map("item_type") @db.VarChar(500)
  count      Int      @map("quantity")
  sourceLink String?  @map("source_link") @db.VarChar(2000)
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  subtotal   Decimal  @default(0) @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("order_items")
}

model File {
  id            String    @id @default(uuid()) @db.Uuid
  orderId       String    @map("order_id") @db.Uuid
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fileName      String    @map("file_name") @db.VarChar(500)
  fileType      String    @map("file_type") @db.VarChar(50)
  fileSize      BigInt    @map("file_size")
  storageBucket String    @map("storage_bucket") @db.VarChar(100)
  storagePath   String    @map("storage_path") @db.VarChar(1000)
  publicUrl     String?   @map("public_url")
  hasWatermark  Boolean   @default(false) @map("has_watermark")
  uploadedAt    DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz
  expiresAt     DateTime? @map("expires_at") @db.Timestamptz

  @@map("files")
}

model Subscription {
  id                    String    @id @default(uuid()) @db.Uuid
  userId                String    @map("user_id") @db.Uuid
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                  String    @db.VarChar(50)
  status                String    @default("active") @db.VarChar(50)
  gateway               String    @default("INTERNAL") @db.VarChar(50)
  gatewaySubscriptionId String?   @unique @map("gateway_subscription_id") @db.VarChar(255)
  startedAt             DateTime  @default(now()) @map("started_at") @db.Timestamptz
  expiresAt             DateTime  @map("expires_at") @db.Timestamptz
  nextBillingAt         DateTime? @map("next_billing_at") @db.Timestamptz
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@map("subscriptions")
}

model Payment {
  id              String         @id @default(uuid()) @db.Uuid
  paymentNumber   String         @unique @map("payment_number") @db.VarChar(50)
  orderId         String         @map("order_id") @db.Uuid
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId          String         @map("user_id") @db.Uuid
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  gateway         PaymentGateway @default(STRIPE)
  transactionId   String?        @map("transaction_id") @db.VarChar(255)
  amount          Decimal        @db.Decimal(10, 2)
  currency        String         @default("USD") @db.VarChar(10)
  status          PaymentStatus  @default(PENDING)
  gatewayResponse Json?          @map("gateway_response")
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz
  completedAt     DateTime?      @map("completed_at") @db.Timestamptz

  @@map("payments")
}

model Wallet {
  id        String         @id @default(uuid()) @db.Uuid
  userId    String         @unique @map("user_id") @db.Uuid
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance   Decimal        @default(0) @db.Decimal(12, 2)
  currency  String         @default("USD") @db.VarChar(10)
  createdAt DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  ledgers   WalletLedger[]

  @@map("wallets")
}

model WalletLedger {
  id           String           @id @default(uuid()) @db.Uuid
  walletId     String           @map("wallet_id") @db.Uuid
  wallet       Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  userId       String           @map("user_id") @db.Uuid
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId      String?          @map("order_id") @db.Uuid
  order        Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  type         WalletLedgerType @default(ADJUSTMENT)
  amount       Decimal          @db.Decimal(12, 2)
  balanceAfter Decimal          @map("balance_after") @db.Decimal(12, 2)
  currency     String           @default("USD") @db.VarChar(10)
  description  String?          @db.VarChar(500)
  reference    String?          @db.VarChar(255)
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz

  @@index([walletId, createdAt])
  @@index([userId, createdAt])
  @@map("wallet_ledgers")
}
